<!DOCTYPE html>
<div th:include="fragments/js :: jquery"></div>
<div th:include="fragments/js :: bootstrap"></div>


<html xmlns:th="http://www.thymeleaf.org">

<script>
    function deleteResponse(userID, eventID){
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){
                //document.getElementById("demo").innerHTML = this.responseText;
                $(`#${eventID}`).parent().parent().remove();
            }
        };
        let requestURL = `http://localhost:8080/api/Event/${eventID}/Response`
        xhttp.open("DELETE", requestURL);
        xhttp.send();
        //$(`#${eventID}`).parent().append('<div class="spinner-border" role="status"><span class="visually-hidden">Working...</span></div>');
        $(`#${eventID}`).text("Deleting...");
    }
</script>

<head>
    <title>Lets Meet</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>

<body>
<div class="container">
    <div th:insert="fragments/layout :: sidebar"></div>

    <!-- Page Content  -->
    <div id="content">

        <div th:insert="fragments/layout :: navbar"></div>


<div class = "jumbotron">
    <div class = "container">
        <h1>Your Dashboard</h1>
    </div>
</div>

<script>
    var thearrayofevents = [];
</script>

<div class = "container">
    <h2>Your Events</h2>
    <div class = "alert alert-warning" th:if = "${noEvents}">You are not currently in any events.</div>
    <div th:include="fragments/common :: alerts"></div>
    <div th:unless = "${noEvents}">
        <table class = "table table">
            <thead>
                <tr>
                    <th scope = "col">Event Name</th>
                    <th scope = "col">Description</th>
                    <th scope = "col">Location</th>
                    <th scope = "col"></th>
                    <th scope = "col"></th>
                </tr>
            </thead>
            <tbody>
                <tr th:each = "myEvents : ${myEvents}">
                    <td th:text = "${myEvents.name}"></td>
                    <td th:text = "${myEvents.description}"></td>
                    <td th:text = "${myEvents.location}"></td>
                    <td><a class = "btn btn-primary" th:href = "@{/event/{eventuuid}(eventuuid = ${myEvents.getUUID()})}">View</a></td>
                    <td><a class = "btn btn-danger" th:href = "@{/deleteevent/{eventuuid}(eventuuid = ${myEvents.getUUID()})}">Delete</a></td>
                    <script th:inline="javascript">
                        /*<![CDATA[*/

                        var theEvent = /*[[${myEvents}]]*/ 'default';
                        if (theEvent.eventProperties.times.length > 0) {
                            console.log("This event: " + theEvent.name + " has dates.")
                            thearrayofevents.push(theEvent);
                        }

                        /*]]>*/
                    </script>
                </tr>
            </tbody>
        </table>
    </div>

    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button" style="display: none;" class = "btn btn-primary">Authorize</button>

    <button id="signout_button" style="display: none;" class = "btn btn-danger">Sign Out</button>
    <button class = "btn btn-success" onclick= "addevent()" type = "button">Sync LetsMeet Events with Google Calendar</button>

    <pre id="content2" style="white-space: pre-wrap;"></pre>

    <script type="text/javascript">

        console.log(thearrayofevents);

        // Client ID and API key from the Developer Console
        var CLIENT_ID = '164492643464-2blf4kgnb9ss7kpqc34q9vp1r6r1e4f8.apps.googleusercontent.com';
        var API_KEY = 'AIzaSyCgRpI_4mK4C98iJX-CklyncB3jZRfMljU';

        // Array of API discovery doc URLs for APIs used by the quickstart
        var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

        // Authorization scopes required by the API; multiple scopes can be
        // included, separated by spaces.
        var SCOPES = "https://www.googleapis.com/auth/calendar";

        var authorizeButton = document.getElementById('authorize_button');
        var signoutButton = document.getElementById('signout_button');

        /**
         *  On load, called to load the auth2 library and API client library.
         */
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        /**
         *  Initializes the API client library and sets up sign-in state
         *  listeners.
         */
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function () {
                // Listen for sign-in state changes.
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

                // Handle the initial sign-in state.
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                authorizeButton.onclick = handleAuthClick;
                signoutButton.onclick = handleSignoutClick;
            }, function(error) {
                appendPre(JSON.stringify(error, null, 2));
            });
        }

        /**
         *  Called when the signed in status changes, to update the UI
         *  appropriately. After a sign-in, the API is called.
         */
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'block';
                listUpcomingEvents();
            } else {
                authorizeButton.style.display = 'block';
                signoutButton.style.display = 'none';
            }
        }

        /**
         *  Sign in the user upon button click.
         */
        function handleAuthClick(event) {
            gapi.auth2.getAuthInstance().signIn();
        }

        /**
         *  Sign out the user upon button click.
         */
        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }

        /**
         * Append a pre element to the body containing the given message
         * as its text node. Used to display the results of the API call.
         *
         * @param {string} message Text to be placed in pre element.
         */
        function appendPre(message) {
            var pre = document.getElementById('content2');
            var textContent = document.createTextNode(message + '\n');
            pre.appendChild(textContent);
        }

        /**
         * Print the summary and start datetime/date of the next ten events in
         * the authorized user's calendar. If no events are found an
         * appropriate message is printed.
         */
        // function listUpcomingEvents() {
        //     gapi.client.calendar.events.list({
        //         'calendarId': 'primary',
        //         'timeMin': (new Date()).toISOString(),
        //         'showDeleted': false,
        //         'singleEvents': true,
        //         'maxResults': 10,
        //         'orderBy': 'startTime'
        //     }).then(function(response) {
        //         var events = response.result.items;
        //         appendPre('Upcoming events:');
        //
        //         if (events.length > 0) {
        //             for (i = 0; i < events.length; i++) {
        //                 var event = events[i];
        //                 var when = event.start.dateTime;
        //                 if (!when) {
        //                     when = event.start.date;
        //                 }
        //                 appendPre(event.summary + ' (' + when + ')')
        //             }
        //         } else {
        //             appendPre('No upcoming events found.');
        //         }
        //     });
        // }

        function addevent() {

            for (var i = 0; i < thearrayofevents.length; i++) {

                for (var j = 0; j < thearrayofevents[i].eventProperties.times.length; j++) {

                    var event = {

                        'summary': thearrayofevents[i].name,
                        'start': {

                            'dateTime': thearrayofevents[i].eventProperties.times[j].start,

                        },
                        'end' : {

                            'dateTime' : thearrayofevents[i].eventProperties.times[j].end,

                        }
                    }

                    var request = gapi.client.calendar.events.insert({
                        'calendarId': 'primary',
                        'resource': event
                    });

                    request.execute(function (event) {
                        appendPre('Event created: ' + event.htmlLink);
                    });

                }

            }

        }

    </script>

    <script defer src="https://apis.google.com/js/api.js"
            onload="this.onload=function(){};handleClientLoad()"
            onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>


    <h2>Your Invitations</h2>
    <div>
        <table class = "table table">
            <thead>
                <tr>
                    <th scope = "col">Event Name</th>
                    <th scope = "col">Required</th>
                    <th scope = "col">Responded</th>
                    <th scope = "col"></th>
                </tr>
            </thead>
            <tbody>
                <tr th:each = "response : ${responses}" id="hiya">
                    <div th:if = "${response}">
                        <td th:text = "${response.event.getName()}" ></td>
                        <td th:text = "${response.response.required}"></td>
                        <td th:text = "${response.response.hasResponded()}"></td>
                        <td><a class = "btn btn-primary" th:href = "@{/event/{eventuuid}(eventuuid = ${response.event.getUUID()})}">View</a></td>
                        <td><a class = "btn btn-danger" style=" color: white !important;" th:id = "${response.event.UUID}" onclick="deleteResponse()"
                               th:attr="onclick=|deleteResponse('${user.UUID}','${response.event.UUID}')|">Delete</a></td>
                    </div>
                    <div th:unless = "${response}">
                        <td th:text = "${response} +''">Null entity</td>
                        <td></td>
                        <td></td>
                    </div>
                </tr>
            </tbody>
        </table>
    </div>

    <h2>Your Businesses</h2>
    <div>
        <table class = "table table">
            <thead>
                <tr>
                    <th width="90%" scope = "col">Business Name</th>
                    <th scope = "col"></th>
                    <th scope = "col"></th>
                </tr>
            </thead>
            <tbody>
                <tr th:each = "b : ${businesses}" id="businessRow">
                    <div th:if ="${b}">
                        <td th:text = "${b.getName()}"></td>
                        <td></td>
                        <td><a class = "btn btn-primary" th:href = "@{/Business/{businessID}(businessID = ${b.getUUID()})}">View</a></td>
                    </div>
                </tr>
            </tbody>
        </table>
    </div>
    <div th:insert="footer :: footer"></div>
</div>



    </div>
    <div th:insert="fragments/layout :: footer"></div>
</div>

</body>

</html>
