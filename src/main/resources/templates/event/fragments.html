<!DOCTYPE html>
<div th:include="fragments/js :: jquery"></div>
<div th:include="fragments/js :: bootstrap"></div>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Lets Meet</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>

<body>
    <div th:fragment="edit">

        <form th:action="@{/event/{eventUUID}/edit(eventUUID = ${event.getUUID()})}" enctype="multipart/form-data"
            method="post" id="updateForm" name="updateForm">

            <div class="form-group">
                <label for="eventname">Event Name: </label>
                <input type="text" class="form-control" name="eventname" th:value="${event.getName()}">
            </div>

            <div class="form-group">
                <label for="eventdesc">Image: </label>
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="customFile" name="file">
                    <label class="custom-file-label" for="customFile">Choose new file</label>
                </div>
            </div>

            <div class="form-group">
                <label for="eventdesc">Event Description: </label>
                <textarea type="text" class="form-control" name="eventdesc" placeholder="Description..."
                    th:text="${event.getDescription()}"></textarea>
            </div>

            <div class="form-group">
                <label for="eventlocation">Event Location:</label>
                <input type="text" class="form-control" name="eventlocation" placeholder="Location..."
                    th:value="${event.getLocation()}">
            </div>

            <div class="form-group">
                <label for="eventTimes">Event Times:</label>

                <script type="text/javascript"
                        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/js/bootstrap-datepicker.min.js"></script>

                <script>
                    // Counter for the rows
                    var dateRowNo = 0;

                    $(document).ready(function(){
                        $('.add').click(function(){
                            // Read dateRowNo
                            dateRowNo = document.updateForm.rows.value;

                            console.log("Testing here");
                            console.log(dateRowNo);

                            // Day formatting for the generated HTML
                            $(function() {$("#startDay" + dateRowNo).datepicker({ format: 'yyyy-mm-dd' })});
                            $(function() {$("#endDay" + dateRowNo).datepicker({ format: 'yyyy-mm-dd' })});

                            // Incrementing the counter
                            dateRowNo++;
                            $(".list").append(
                                '<div class="row">' +
                                '<label>From:</label>' +
                                '<div class="col">' +
                                '<input type="datetime" class="form-control" placeholder="dd-mm-yyyy" name="startDays" id="startDay' + dateRowNo + '" readonly>' +
                                '</div>' +
                                '<div class="col">' +
                                '<input type="time" class="form-control" step="1" id="startTime' + dateRowNo + '" name="startTimes">' +
                                '</div>' +
                                '<label>Until:</label>' +
                                '<div class="col">' +
                                '<input type="datetime" class="form-control" placeholder="dd-mm-yyyy" name="endDays" id="endDay' + dateRowNo + '" readonly>' +
                                '</div>' +
                                '<div class="col">' +
                                '<input type="time" class="form-control" step="1" id="endTime' + dateRowNo + '" name="endTimes">' +
                                '</div>' +
                                '<div class="row"></div>' +
                                '<div class="col">' +
                                '<p class="btn btn-light remove">Remove</p>' +
                                '</div>' +
                                '</div>');

                            // Write dateRowNo
                            document.updateForm.rows.value = dateRowNo;
                        });

                        $(".list").on('click', '.remove', function(){
                            $(this).parent().parent().remove();
                        });
                    });

                    // Day formatting for pre-included HTML
                    $(function() {$("#startDay0").datepicker({ format: 'yyyy-mm-dd' })});
                    $(function() {$("#endDay0").datepicker({ format: 'yyyy-mm-dd' })});

                    // Finding user's time zone
                    var offset = new Date().getTimezoneOffset();

                    var plusMinusTimeZone = "";
                    if (offset > 0){
                        plusMinusTimeZone = "-";
                    }else{
                        plusMinusTimeZone = "+";
                    }

                    HoursTimeZone = Math.floor(Math.abs(offset)/60).toString();
                    if (HoursTimeZone.length < 2){
                        HoursTimeZone = "0" + HoursTimeZone;
                    }

                    MinutesTimeZone = Math.abs(offset%60).toString();
                    if (MinutesTimeZone.length < 2){
                        MinutesTimeZone = "0" + MinutesTimeZone;
                    }
                </script>

                <div class="container" id="timeRangeGroup">
                    <div class="col list">
                        <div class="row align-items-start" th:each="t : ${times}">
                            <label>From:</label>
                            <div class="col">
                                <input type="datetime" class="form-control" name="startDays" placeholder="dd-mm-yyyy" th:id="${t[4]}"
                                       th:value="${t[0]}" readonly>
                            </div>
                            <div class="col">
                                <input type="time" class="form-control" step="1" th:id="${t[5]}" name="startTimes"
                                th:value="${t[1]}">
                            </div>

                            <label>Until:</label>
                            <div class="col">
                                <input type="datetime" class="form-control" name="endDays" placeholder="dd-mm-yyyy" th:id="${t[6]}"
                                       th:value="${t[2]}" readonly>
                            </div>
                            <div class="col">
                                <input type="time" class="form-control" step="1" th:id="${t[7]}" name="endTimes"
                                th:value="${t[3]}">
                            </div>
                            <div class="row"></div>
                            <div class="col">
                                <p class="btn btn-light remove">Remove</p>
                            </div>
                        </div>
                    </div>

                    <div class="col">
                        <p class="btn btn-light add" id="add">Add</p>
                    </div>

                    <input type="hidden" name="jsonTimes" id="jsonTimes" value="">
                    <input type="hidden" name="rows" id="rows" th:value="${rows}">
                </div>
            </div>

            <script>
                function JSONFormatting() {
                    var eventDates = [];
                    dateRowNo = document.updateForm.rows.value;
                    for (i=0; i<dateRowNo+1; i++) {
                        if (document.getElementById('startDay'+i) !== null) {
                            var startDay = document.getElementById('startDay'+i).value;
                            var startTime = document.getElementById('startTime'+i).value;
                            var endDay = document.getElementById('endDay'+i).value;
                            var endTime = document.getElementById('endTime'+i).value;
                            const startDate = startDay + 'T' + startTime + plusMinusTimeZone + HoursTimeZone + ":" + MinutesTimeZone;
                            const endDate = endDay + 'T' + endTime + plusMinusTimeZone + HoursTimeZone + ":" + MinutesTimeZone;
                            let dateEntry = new Map()
                            dateEntry['start'] = startDate;
                            dateEntry['end'] = endDate;
                            eventDates.push(dateEntry);
                            console.log(eventDates);
                        }
                    }
                    document.updateForm.jsonTimes.value = JSON.stringify(eventDates);
                    document.forms["updateForm"].submit();
                }
            </script>

            <button onclick="JSONFormatting()" class="btn btn-primary">Save</button>
        </form>

    </div>

    <div th:fragment="invite">
        <form th:action="@{/event/{eventUUID}/users(eventUUID = ${event.getUUID()})}" enctype="multipart/form-data" th:method="POST">
            <div class="form-group pb-2">
                <div class="container">
                    <h5>Invite <i>anyone</i></h5>
                    <p>Easily invite guests to your Meet using their email or Let's Meet ID, we'll let them know you invited them.</p>
                    <p>They do not need a Let's Meet account.</p>
                </div>
            </div>

            <div class="form-group">
                <div class="container" id="usersRequired">
                <div class="input-group mb-3">  
                    <input type="text" class="form-control" id="myInput" name="usersRequired" placeholder="Let's Meet ID or email"
                           aria-label="Recipient's UUID" aria-describedby="basic-addon2">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" id="but_add" type="button"><i class="bi bi-plus"></i></button>
                    </div>
                </div>
                    
                </div>
            </div>
            <div class="container">
                <button type="submit" class="btn btn-primary btn-block"><i class="bi bi-envelope-fill"></i> Send Invitation</button>
            </div>
        </form>

        
        <script>
            $(document).ready(function () {
        
                $('#but_add').click(function () {
                    var html = '<div class="input-group mb-3"><input type="text" class="form-control" id="myInput" name="usersRequired" ' +
                        'placeholder="Let\'s Meet ID or email" aria-label="Recipient\'s UUID" aria-describedby="basic-addon2">' +
                        '<div class="input-group-append"> <button class="btn btn-outline-secondary" id="but_add" type="button" onclick="remove(this)">' +
                        '<i class="bi bi-dash"></i></button></div></div>';
                    var b = document.getElementById("but_add").parentElement.parentElement;
                    $(html).insertAfter(b);
                });
        
            });
        </script>

        <script>
            function remove(el){
                var myobj = el.parentElement.parentElement;
                myobj.remove();
            }
        </script>
    </div>

    <div th:fragment="confirm">

            <form th:action="@{/event/{eventUUID}/results/confirm(eventUUID = ${event.getUUID()})}" enctype="multipart/form-data" method="post">

            <div class="form-group">
                <label for="message">Message (optional) </label>
                <textarea type="text" class="form-control" name="message"></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-block">Send Confirmation</button>
        </form>

    </div>

    <div th:fragment="facilities_selector">
        <div class="input-group mb-3 content">
            <input id="venues" type="text" name="serviceName" class="form-control autocomplete" placeholder="Facility/Service" aria-label="Facility/Service" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <button class="btn btn-outline-primary" id="addRange" type="button" value="hi"><i class="bi bi-plus-square-fill"></i> Add</button>
            </div>
          </div>
        <script>
            var facilities = ["abbey", "after-hours joint", "ale house", "alehouse", "amphitheater", "amphitheatre", "arena", "armory", "assembly hall", "assembly room", "auditorium", "ballroom", "bar", "barbecue", "barn", "barroom", "basilica", "beer garden", "beer-joint", "bethel", "big screen", "bijou", "bistro", "boards", "bowl", "cafeteria", "café", "canteen", "casino", "cathedral", "chamber", "chancel", "chantry", "chapel", "chophouse", "church", "cine", "cinema", "circus", "clambake", "clinic", "club", "cocktail-lounge", "coffee-shop", "collage", "coliseum", "concert hall", "cookout", "course", "dance hall", "deck", "diamond", "diner", "dining alfresco", "dining hall", "dining room", "dive", "doughnut shop", "drama", "drinkery", "drinking establishment", "drive-in", "eatery", "eating", "emergency room", "excursion", "fast food", "field", "film", "fire station", "fish fry", "flicks", "fold", "footlights", "garden", "gallery", "gin mill", "greasy spoon", "gridiron", "grill", "ground", "gym", "gymnasium", "hall", "hamburger stand", "hashery", "health service", "hideaway", "hippodrome", "hole", "hospice", "hospital", "hotdog stand", "house", "house of God", "house of prayer", "house of worship", "ice", "infirmary", "inn", "institution", "joint", "locale", "Lord's house", "lounge", "luncheonette", "lunchroom", "lyceum", "mart", "meeting place", "minster", "mission", "mosque", "motion pictures", "movie", "movie house", "movie theater", "moving pictures", "music hall", "nabes", "night club", "nursing home", "oak", "odeum", "opera", "opera house", "oratory", "outing", "outlet", "parish", "park", "photoplay", "picnic", "picture show", "pictures", "pit", "pizzeria", "place", "platform", "playhouse", "police headquarters", "police station", "precinct house", "pub", "public", "public house", "rathskeller", "reception hall", "refectory", "rest home", "ring", "rink", "roadhouse", "room", "sacellum", "salon", "saloon", "sanatorium", "sanctuary", "sanitarium", "scene", "school", "show", "show-hall", "shrine", "sick bay", "silver screen", "site", "soda fountain", "square", "stadium", "stage", "stateroom", "surgery", "synagogue", "tabernacle", "tap", "taproom", "tavern", "temple", "theater", "theatre", "university", "variety theater", "vaudeville theater", "ward", "watering", "watering hole", "weiner roast"];
            
            function autocomplete(inp, arr) {
                var current;
                inp.addEventListener("input", function(e) {
                    var x, y, i, val = this.value;
                    closeAllLists();
                    if (!val) { return false;}
                    current = -1;
                    x = document.createElement("DIV");
                    x.setAttribute("id", this.id + "autocomplete-list");
                    x.setAttribute("class", "autocomplete-items");
                    this.parentNode.appendChild(x);
                    for (i = 0; i < arr.length; i++) {
                        if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                            y = document.createElement("DIV");
                            y.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                            y.innerHTML += arr[i].substr(val.length);
                            y.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                            y.addEventListener("click", function(e) {
                                inp.value = this.getElementsByTagName("input")[0].value;
                                closeAllLists();
                                });
                            x.appendChild(y);
                            }
                        }
                    });
                
                inp.addEventListener("keydown", function(e) {
                    var x = document.getElementById(this.id + "autocomplete-list");
                    if (x) x = x.getElementsByTagName("div");
                        if (e.keyCode == 40) {
                        current++;
                        addActive(x);
                        } else if (e.keyCode == 38) {
                            current--;
                            addActive(x);
                        } else if (e.keyCode == 13) {
                            e.preventDefault();
                            if (current > -1) {
                                if (x) x[current].click();
                            }
                        }
                    });
                
                function addActive(x) {
                    if (!x) return false;
                    removeActive(x);
                    if (current >= x.length) current = 0;
                    if (current < 0) current = (x.length - 1);
                    x[current].classList.add("autocomplete-active");
                }
                
                function removeActive(x) {
                    for (var i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                    }
                }
                
                function closeAllLists(elmnt) {
                    var x = document.getElementsByClassName("autocomplete-items");
                    for (var i = 0; i < x.length; i++) {
                        if (elmnt != x[i] && elmnt != inp) {
                            x[i].parentNode.removeChild(x[i]);
                        }
                    }
                }
                
                document.addEventListener("click", function (e) {
                    closeAllLists(e.target);
                    });
                }

            autocomplete(document.getElementById("venues"), facilities);
            
            
            
            
            $(document).ready(function () {
                $('#addRange').click(function () {
                    var serviceName = $(this).closest("div.content").find("input[name='serviceName']").val();
                    if (serviceName.length < 1){
                        alert("Can't be empty");
                        return;
                    }
                    //alert(JSON.stringify(serviceName));
                    //alert(this.closest('form-control').value);
                    var facilitiesMarkup = `
                        <div class="card w-100 mt-2 bg-light">
                            <div class="card-body">
                                <input hidden type="text" name="facilities"value='${serviceName}'/>
                                <div class="row align-items-center">
                                    <div class="col-sm-10">
                                        <div class="row">
                                            <div class="span10">
                                                <p class="card-text">${serviceName}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-2">
                                        <button type="button" id="hiya" class="btn btn-light myButton" onclick="$(this).closest('div.card').fadeOut('fast',function(){$(this).closest('div.card').remove();});"><i class="bi bi-x"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    $("#facilitiesList").append(facilitiesMarkup);
                    $(this).closest("div.content").find("input[name='serviceName']").val("");
                });
            });
        </script>
    </div>

    <div th:fragment="poll_creator">
        <!-- Button trigger modal -->
        <button type="button" class="btn btn-outline-primary btn-block" data-toggle="modal" data-target="#exampleModal">
            <i class="bi bi-plus-square-fill"></i>
            New
        </button>
        
        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">New Poll</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="pollName">Poll Name</label>
                        <input type="text" class="form-control" id="pollName" placeholder="Name">
                      </div>
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="pollMultiSelect">
                        <label class="form-check-label" for="pollMultiSelect">Multiselect</label>
                      </div>
                    <div class="form-group">
                            
                            <div class="input-group mb-3">  
                                <input type="text" class="form-control" id="myInput" name="Option" placeholder="Option"
                                        aria-label="Recipient's UUID" aria-describedby="basic-addon2">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" id="but_add" type="button"><i class="bi bi-plus"></i></button>
                                </div>
                            </div>
                            
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"  data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="savePoll" data-dismiss="modal">Save changes</button>
                </div>
            </div>
            </div>
        </div>
        <script>
            $(document).ready(function () {
        
                $('#but_add').click(function () {
                    var html = '<div class="input-group mb-3"><input type="text" class="form-control" name="Option" ' +
                        'placeholder="Option" aria-label="Recipient\'s UUID" aria-describedby="basic-addon2">' +
                        '<div class="input-group-append"> <button class="btn btn-outline-secondary" id="but_add" type="button" onclick="remove(this)">' +
                        '<i class="bi bi-dash"></i></button></div></div>';
                    var b = document.getElementById("but_add").parentElement.parentElement;
                    $(html).insertAfter(b);
                });
                $('#savePoll').click(function () {
                    var poll = {name: "myPoll", multiselect: true, options: []};
                    poll.name = $("#pollName").val();
                    poll.multiselect = $("#pollMultiSelect").is(":checked");
                    var options = $(this).closest("div.modal-content").find("input[name='Option']");
                    var i = 0
                    for (i = 0; i < options.length; i++) {
                        //poll.options.push(options[i].value);
                        poll.options.push([options[i].value, 0])
                    } 
                    console.log(`Poll <${poll.name}> with multiselect=${poll.multiselect} created with options <${poll.options}>`);
                    var json = JSON.stringify(poll);
                    //alert(json);
                    poll.options.push()
                    var pollMarkup = `
                        <div class="card w-100 mt-2 bg-light">
                            <div class="card-body">
                                <input hidden type="text" name="polls"value='${json}'/>
                                <div class="row align-items-center">
                                    <div class="col-sm-10">
                                        <div class="row">
                                            <div class="span10">
                                                <h5 class="card-text">${poll.name}</h5>`;
                    for (i in poll.options) {
                        pollMarkup += poll.options[i][0] + "<br>";
                    }
                    pollMarkup += `</div>
                                   </div>
                                   </div>
                                   <div class="col-sm-2">
                                       <button type="button" id="hiya" class="btn btn-light myButton" onclick="$(this).closest('div.card').fadeOut('fast',function(){$(this).closest('div.card').remove();});"><i class="bi bi-x"></i></button>
                                   </div>
                                </div>
                            </div>
                        </div>
                    `;
                    $("#pollList").append(pollMarkup);

                    var pollMarkup = `
                        <div class="card w-100 mt-2 bg-light">
                            <div class="card-body">
                                <input hidden type="text" name="polls"value='${json}'/>
                                <div class="row align-items-center">
                                    <div class="col-sm-10">
                                        <div class="row">
                                            <div class="span10">
                                                <h5 class="card-text">${poll.name}</h5>`;
                    for (i in poll.options) {
                        pollMarkup += poll.options[i][0] + " " + poll.options[i][1] + "<br>";
                    }
                    pollMarkup += `</div>
                                   </div>
                                   </div>
                                   <div class="col-sm-2">
                                       <button type="button" id="hiya" class="btn btn-light myButton" onclick="$(this).closest('div.card').fadeOut('fast',function(){$(this).closest('div.card').remove();});"><i class="bi bi-x"></i></button>
                                   </div>
                                </div>
                            </div>
                        </div>
                    `;
                    $("#pollListResponse").append(pollMarkup);
                });        
            });
        </script>



            </div>

    <div th:fragment="poll_responder(_polls)">
        <div class="card w-100 mt-2 bg-light poll-responder" th:each="_poll : ${_polls}">
            <input hidden type="text" name="pollResponse" value='[]'/>
            <input hidden type="text" name="pollMultiSelect" th:value="${_poll.multiselect}"/>
            <div class="card-header" th:text="${_poll.name}">
                Featured
            </div>
            <div class="card-body">
                <p class="text-sm-left" th:if="${_poll.multiselect}">Choose one or more: </p>
                <p class="text-sm-left" th:unless="${_poll.multiselect}">Choose one: </p>
                <div class="card w-100 mt-2 bg-light" th:each="_option : ${_poll.options}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-sm-10">
                                <h5 class="card-text lm-option-name" th:text="${_option.key}">With supporting text below as a natural lead-in to additional content.</h5>
                            </div>
                            <div class="col-sm-2">
                                <div class="custom-control custom-checkbox" style="vertical-align: top; float: right;">
                                    <input type="checkbox" class="custom-control-input poll-option-checkbox" th:id="${_option.key}">
                                    <label class="custom-control-label" th:for="${_option.key}"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <div th:fragment="poll_viewer(_polls)">
        <div class="card w-100 mt-2 bg-light poll-responder" th:each="_poll : ${_polls}">
            <input hidden type="text" name="pollResponse" value='[]'/>
            <input hidden type="text" name="pollMultiSelect" th:value="${_poll.multiselect}"/>
            <div class="card-header" th:text="${_poll.name}">
                Featured
            </div>
            <div class="card-body">
                <p class="text-sm-left" th:if="${_poll.multiselect}">Mutiselect Poll </p>
                <div class="card w-100 mt-2 bg-light" th:each="_option : ${_poll.options}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-sm-10">
                                <h5 class="card-text lm-option-name" th:text="${_option.key}"></h5>

                            </div>
                            <div class="col-sm-2">
                                <h5 class="card-text lm-option-name" th:text="'Votes: ' + ${_option.value}"></h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <div th:fragment="mapsFragment">

        <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
        <style type="text/css">
            /* Always set the map height explicitly to define the size of the div
             * element that contains the map. */
            #map {
                height: 100%;
            }

            /* Optional: Makes the sample page fill the window. */
            html,
            body {
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #description {
                font-family: Roboto;
                font-size: 15px;
                font-weight: 300;
            }

            #infowindow-content .title {
                font-weight: bold;
            }

            #infowindow-content {
                display: none;
            }

            #map #infowindow-content {
                display: inline;
            }

            .pac-card {
                margin: 10px 10px 0 0;
                border-radius: 2px 0 0 2px;
                box-sizing: border-box;
                -moz-box-sizing: border-box;
                outline: none;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                background-color: #fff;
                font-family: Roboto;
            }

            #pac-container {
                padding-bottom: 12px;
                margin-right: 12px;
            }

            .pac-controls {
                display: inline-block;
                padding: 5px 11px;
            }

            .pac-controls label {
                font-family: Roboto;
                font-size: 13px;
                font-weight: 300;
            }


            #pac-input:focus {
                border-color: #4d90fe;
            }

            #title {
                color: #fff;
                background-color: #4d90fe;
                font-size: 25px;
                font-weight: 500;
                padding: 6px 12px;
            }

            #target {
                width: 345px;
            }

            input.form-control:read-only {
                background-color: #fff;
            }
        </style>

        <script>
            // This example requires the Places library. Include the libraries=places
            // parameter when you first load the API. For example:
            // <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBIwzALxUPNbatRBj3Xi1Uhp0fFzwWNBkE&libraries=places">

            function initMap() {
            const map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 55.3781, lng: -2.4360 },
            zoom: 5,
            streetViewControl: false,
            mapTypeControl: false,
        });
            infoWindow = new google.maps.InfoWindow();
            const locationButton = document.createElement("button");
            locationButton.type = 'button';
            locationButton.setAttribute('class', 'btn btn-light');
            locationButton.setAttribute('style', 'margin: 10px;');
            locationButton.textContent = "Current Location";
            locationButton.classList.add("custom-map-control-button");
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(locationButton);
            locationButton.addEventListener("click", () => {
            // Try HTML5 geolocation.
            if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
            (position) => {
            const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
        };
            map.setZoom(14);
            infoWindow.setPosition(pos);
            map.setCenter(pos);
        },
            () => {
            handleLocationError(true, infoWindow, map.getCenter());
        }
            );
        } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, infoWindow, map.getCenter());
        }
        });
            const card = document.getElementById("pac-card");
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(card);
            const center = { lat: 50.064192, lng: -130.605469 };
            // Create a bounding box with sides ~10km away from the center point
            const defaultBounds = {
            north: center.lat + 0.1,
            south: center.lat - 0.1,
            east: center.lng + 0.1,
            west: center.lng - 0.1,
        };
            const input = document.getElementById("pac-input");
            const options = {
            bounds: defaultBounds,
            componentRestrictions: { country: "uk" },
            fields: ["address_components", "geometry", "icon", "name"],
            origin: center,
            strictBounds: false,
            types: ["establishment"],
        };
            const autocomplete = new google.maps.places.Autocomplete(
            input,
            options
            );
            // Set initial restriction to the greater list of countries.
            autocomplete.setComponentRestrictions({
            country: ["uk", "pr", "vi", "gu", "mp"],
        });
            const southwest = { lat: 5.6108, lng: 136.589326 };
            const northeast = { lat: 61.179287, lng: 2.64325 };
            const newBounds = new google.maps.LatLngBounds(southwest, northeast);
            autocomplete.setBounds(newBounds);
            const infowindow = new google.maps.InfoWindow();
            const infowindowContent = document.getElementById("infowindow-content");
            infowindow.setContent(infowindowContent);
            let marker = new google.maps.Marker({
            map,
            anchorPoint: new google.maps.Point(0, -29),
        });
            autocomplete.addListener("place_changed", () => {
            infowindow.close();
            marker.setVisible(false);
            const place = autocomplete.getPlace();
            document.getElementById("myRange").disabled = false;

            document.getElementById('thelat').value = place.geometry.location.lat();
            document.getElementById('thelong').value = place.geometry.location.lng();
            document.getElementById("theLocation").value = input.value;

            var circle = new google.maps.Circle({
            map: map,
            radius: 0,
            fillColor: '#AA0000',
            fillOpacity: 0.17,
            strokeOpacity: 0.5,
            strokeWeight: 1,
        });

            var somerad = document.getElementById('myRange').value * 1000;
            circle.setRadius(somerad);

            $('#myRange').change(function() {
            var new_rad = $(this).val();
            var rad = new_rad * 1000;

            circle.setRadius(rad);
        });

            circle.bindTo('center', marker, 'position');

            if (!place.geometry || !place.geometry.location) {
            // User entered the name of a Place that was not suggested and
            // pressed the Enter key, or the Place Details request failed.
            window.alert(
            "No details available for input: '" + place.name + "'"
            );
            return;
        }

            // If the place has a geometry, then present it on a map.
            if (place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport);
        } else {
            map.setCenter(place.geometry.location);
            map.setZoom(17); // Why 17? Because it looks good.
        }
            marker.setPosition(place.geometry.location);
            marker.setVisible(true);
            let address = "";

            if (place.address_components) {
            address = [
            (place.address_components[0] &&
            place.address_components[0].short_name) ||
            "",
            (place.address_components[1] &&
            place.address_components[1].short_name) ||
            "",
            (place.address_components[2] &&
            place.address_components[2].short_name) ||
            "",
            ].join(" ");
        }
            infowindowContent.children["place-icon"].src = place.icon;
            infowindowContent.children["place-name"].textContent = place.name;
            infowindowContent.children["place-address"].textContent = address;
            infowindow.open(map, marker);
        });

            var geocoder = new google.maps.Geocoder();
            var counter = 0;

            function placeMarker(location) {

            infowindow.close();

            if (marker == null)
        {

        }
            else
        {
            marker.setPosition(location);
        }

            if (counter === 0){
            var circle = new google.maps.Circle({
            map: map,
            radius: 0,
            fillColor: '#AA0000',
            fillOpacity: 0.17,
            strokeOpacity: 0.5,
            strokeWeight: 1,
        });}

            var somerad = document.getElementById('myRange').value * 1000;
            circle.setRadius(somerad);

            // Add circle overlay and bind to marker
            $('#myRange').change(function() {
            var new_rad = $(this).val();
            var rad = new_rad * 1000;

            circle.setRadius(rad);
        });

            document.getElementById("myRange").disabled = false;
            circle.bindTo('center', marker, 'position');
            counter = counter + 1

        }

            google.maps.event.addListener(map, 'click', function(event) {
            geocoder.geocode({
            'latLng': event.latLng
        }, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
            if (results[0]) {
            document.getElementById("pac-input").value = results[0].formatted_address;
            document.getElementById("theLocation").value = results[0].formatted_address;
            placeMarker(event.latLng);
            map.panTo(event.latLng);
            document.getElementById('thelat').value = results[0].geometry.location.lat();
            document.getElementById('thelong').value = results[0].geometry.location.lng();
        }
        }
        });
        });

            // Sets a listener on a given radio button. The radio buttons specify
            // the countries used to restrict the autocomplete search.
            function setupClickListener(id, countries) {
            const radioButton = document.getElementById(id);
            radioButton.addEventListener("click", () => {
            autocomplete.setComponentRestrictions({ country: countries });
        });
        }
            setupClickListener("changecountry-usa", "uk");
            setupClickListener("changecountry-usa-and-uot", [
            "uk",
            "pr",
            "vi",
            "gu",
            "mp",
            ]);}
        </script>

        <div class = "container">
            <div class="form-group">
                <label for="eventlocation">Event Location:</label>
                <div id="pac-container">
                    <input id="pac-input" class = "form-control" type="text" placeholder="Enter a location" />
                </div>
            </div>
            <div id="map" style="clear:both; height:400px;"></div>
            <div id="infowindow-content">
                <img src="" width="16" height="16" id="place-icon" />
                <span id="place-name" class="title"></span><br />
                <span id="place-address"></span>
            </div>

            <!-- Async script executes immediately and must be after any DOM elements used in callback. -->
            <script
                    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMn74scKbtj08l2F7jN0c-Dv2gbTp4Mrs&callback=initMap&libraries=places&v=weekly"
                    async
            ></script>

<!--            <input type="hidden" name="latitude" id="thelat"/>-->
<!--            <input type="hidden" name="longitude" id="thelong"/>-->
        </div>

        <div class = "form-group">
            <div class = "container">
                <label for = "myRange">Radius (km): </label>
                <input type = "range" name = "radius" id = "myRange" style = "width: 75%;" step = "0.25" value = "1" disabled>
                <span id = "demo"></span>
            </div>
        </div>

        <script>

            var slider = document.getElementById("myRange");
            var output = document.getElementById("demo");
            output.innerHTML = slider.value;


            slider.oninput = function() {
                output.innerHTML = this.value;
                document.getElementById("myRange2").value = parseFloat(document.getElementById("myRange").value);
            }

        </script>
    </div>

    <div th:fragment="googleCalendar">
        <div class = "card">
            <div class = "card-header">Google Calendar Sync</div>
            <div class = "card-body">
                <p>Sync your LetsMeet events with your Google Calendar. Requires events with dates/times and whitelisted Google account.</p>
        <button id="authorize_button" type = "button" style="display: none;" class = "btn btn-primary btn-block">Authorize</button>
        <button id="signout_button" type = "button" style="display: none;" class = "btn btn-danger">Sign Out</button>
        <button id = "syncButton" onclick = "addevent()"  style = "display:block;" type = "button" class = "btn btn-primary">Sync</button>

        <script type="text/javascript">
            // Client ID and API key from the Developer Console
            var CLIENT_ID = '164492643464-2blf4kgnb9ss7kpqc34q9vp1r6r1e4f8.apps.googleusercontent.com';
            var API_KEY = 'AIzaSyCgRpI_4mK4C98iJX-CklyncB3jZRfMljU';

            // Array of API discovery doc URLs for APIs used by the quickstart
            var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

            // Authorization scopes required by the API; multiple scopes can be
            // included, separated by spaces.
            var SCOPES = "https://www.googleapis.com/auth/calendar";

            var syncButton = document.getElementById('syncButton');
            var authorizeButton = document.getElementById('authorize_button');
            var signoutButton = document.getElementById('signout_button');

            /**
             *  On load, called to load the auth2 library and API client library.
             */
            function handleClientLoad() {
                gapi.load('client:auth2', initClient);
            }

            /**
             *  Initializes the API client library and sets up sign-in state
             *  listeners.
             */
            function initClient() {
                gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: DISCOVERY_DOCS,
                    scope: SCOPES
                }).then(function () {
                    // Listen for sign-in state changes.
                    gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

                    // Handle the initial sign-in state.
                    updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                    authorizeButton.onclick = handleAuthClick;
                    signoutButton.onclick = handleSignoutClick;
                }, function(error) {
                    appendPre(JSON.stringify(error, null, 2));
                });
            }

            /**
             *  Called when the signed in status changes, to update the UI
             *  appropriately. After a sign-in, the API is called.
             */
            function updateSigninStatus(isSignedIn) {
                if (isSignedIn) {
                    authorizeButton.style.display = 'none';
                    signoutButton.style.display = 'block';
                    syncButton.style.display = 'block';
                    listUpcomingEvents();
                } else {
                    authorizeButton.style.display = 'block';
                    signoutButton.style.display = 'none';
                    syncButton.style.display = 'none';
                }
            }

            /**
             *  Sign in the user upon button click.
             */
            function handleAuthClick(event) {
                gapi.auth2.getAuthInstance().signIn();
            }

            /**
             *  Sign out the user upon button click.
             */
            function handleSignoutClick(event) {
                gapi.auth2.getAuthInstance().signOut();
            }

            /**
             * Append a pre element to the body containing the given message
             * as its text node. Used to display the results of the API call.
             *
             * @param {string} message Text to be placed in pre element.
             */
            function appendPre(message) {
                var pre = document.getElementById('content');
                var textContent = document.createTextNode(message + '\n');
                pre.appendChild(textContent);
            }

            function addevent() {

                for (var i = 0; i < thearrayofevents.length; i++) {

                    for (var j = 0; j < thearrayofevents[i].eventProperties.times.length; j++) {

                        var event = {

                            'summary': thearrayofevents[i].name,
                            'start': {

                                'dateTime': thearrayofevents[i].eventProperties.times[j].start,

                            },
                            'end' : {

                                'dateTime' : thearrayofevents[i].eventProperties.times[j].end,

                            }
                        }

                        var request = gapi.client.calendar.events.insert({
                            'calendarId': 'primary',
                            'resource': event
                        });

                        request.execute(function (event) {
                            appendPre('Event created: ' + event.htmlLink);
                        });

                    }

                }

            }

        </script>

        <script async defer src="https://apis.google.com/js/api.js"
                onload="this.onload=function(){};handleClientLoad()"
                onreadystatechange="if (this.readyState === 'complete') this.onload()">
        </script>
    </div>

</body>

